<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Todo List Teavou</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app-view">
        <h1 class="main-title">üìù Todo List Teavou</h1>
        <p class="user-greeting">Halo, <span id="display-username" class="user-name-highlight">User</span>! üëã Selamat beraktivitas.</p>

        <button onclick="logout()" class="logout-btn-fixed">üö™ Keluar</button>

        <div class="card-box">
            <h2>Tambah Tugas Baru</h2>

            <input type="text" id="todo-title" placeholder="Judul Tugas...">
            <textarea id="todo-desc" placeholder="Catatan tambahan..."></textarea>

            <div class="input-row">
                <div class="input-group">
                    <label>üìÖ Batas Waktu:</label>
                    <input type="date" id="todo-date">
                </div>
                <div class="input-group">
                    <label>üé® Warna:</label>
                    <input type="color" id="todo-color" value="#cddc39">
                </div>
            </div>

            <button onclick="addTodo()" class="btn-primary">+ Simpan Tugas</button>
        </div>

        <div class="list-section">
            <div class="section-header">‚è≥ Tugas Aktif</div>
            <div id="active-list"></div>

            <div class="section-header" style="margin-top: 30px;">‚úÖ Riwayat Selesai</div>
            <div id="completed-list"></div>
        </div>
    </div>

    <script>
        const TODO_API = 'http://localhost:3001';
        let token = localStorage.getItem('token');

        if (!token) {
            window.location.href = 'login.html';
        } else {
            const storedUser = localStorage.getItem('username');
            if (storedUser) {
                document.getElementById('display-username').innerText = storedUser;
            }
            fetchTodos();
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        async function fetchTodos() {
            try {
                const res = await fetch(TODO_API + '/todos', {
                    headers: { 'x-auth-token': token }
                });
                if (res.status === 401) { logout(); return; }
                const data = await res.json();
                const todos = Array.isArray(data) ? data : (data.todos || []);
                renderLists(todos);
            } catch (err) { console.error(err); }
        }

        function renderLists(todos) {
            const activeList = document.getElementById('active-list');
            const completedList = document.getElementById('completed-list');
            activeList.innerHTML = ''; completedList.innerHTML = '';

            if (todos.length === 0) activeList.innerHTML = '<p style="text-align:center; color:#999;">Belum ada tugas.</p>';

            todos.forEach(todo => {
                const div = document.createElement('div');
                let borderColor = todo.isCompleted ? '#28a745' : (todo.cardColor || '#cddc39');
                const dateDisplay = todo.deadline ? todo.deadline.split('T')[0] : '';

                div.className = 'todo-item';
                div.style.borderLeftColor = borderColor;
                if (todo.isCompleted) {
                    div.style.opacity = '0.7';
                    div.style.backgroundColor = '#f9f9f9';
                }

                div.innerHTML = `
                    <div class="todo-content" onclick="toggleStatus('${todo._id}')">
                        <div class="todo-title" style="${todo.isCompleted ? 'text-decoration: line-through; color: #888;' : ''}">${todo.title}</div>
                        <div class="todo-desc">${todo.description || '-'}</div>
                        <div class="todo-meta">
                            ${dateDisplay ? `<span class="date-badge">üìÖ ${dateDisplay}</span>` : ''}
                            <span class="status-text ${todo.isCompleted ? 'text-success' : 'text-warning'}">
                                ${todo.isCompleted ? '‚úî Selesai' : '‚óã Klik untuk selesaikan'}
                            </span>
                        </div>
                    </div>
                    <button class="btn-delete" onclick="deleteTodo('${todo._id}')">Hapus</button>
                `;

                if (todo.isCompleted) completedList.appendChild(div);
                else activeList.appendChild(div);
            });
        }

        async function addTodo() {
            const title = document.getElementById('todo-title').value;
            const descInput = document.getElementById('todo-desc').value;
            const deadline = document.getElementById('todo-date').value;
            const colorInput = document.getElementById('todo-color').value;

            if (!title) return alert("Judul tugas wajib diisi!");

            await fetch(TODO_API + '/todos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                body: JSON.stringify({ title, description: descInput, deadline, cardColor: colorInput })
            });

            document.getElementById('todo-title').value = '';
            document.getElementById('todo-desc').value = '';
            document.getElementById('todo-date').value = '';
            document.getElementById('todo-color').value = '#cddc39';
            fetchTodos();
        }

        async function toggleStatus(id) {
            if (!confirm('Apakah Anda yakin ingin mengubah status tugas ini?')) return;
            await fetch(TODO_API + '/todos/' + id, {
                method: 'PATCH',
                headers: { 'x-auth-token': token }
            });
            fetchTodos();
        }

        async function deleteTodo(id) {
            if (!confirm('Hapus tugas ini?')) return;
            await fetch(TODO_API + '/todos/' + id, {
                method: 'DELETE',
                headers: { 'x-auth-token': token }
            });
            fetchTodos();
        }
    </script>
</body>
</html>